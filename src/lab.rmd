---
output:
  html_document: default
  pdf_document: default
---
## Section I: Introduction and Literature Review
 
### A
Summarize how at least two reference materials relate to the basic scientific principles of your experiment. Each reference material must come from a different source. Be sure to describe how the references provide a foundational background for the experiment you will conduct.

## Section II: Hypothesis

### B

Make a hypothesis(es) to predict the effect of a manipulation of an independent variable on a quantitative dependent variable.

### C

Justify your hypothesis(es) based on prior research and known scientific principles.

## Section III: Method

### D

Describe the independent variable(s); include the following information:
* a description of how the variable(s) will be manipulated
* description of experimental conditions, if applicable

#### Software setup

NixOS R Studio
```
# nix-shell -p rstudio -p pandoc -p texliveFull -p libpng -p pkg-config 
```

Workaround for R 4.3.3
```
# install.packages('lattice')
# install.packages('https://cran.r-project.org/src/contrib/Archive/Matrix/Matrix_1.6-5.tar.gz')
# install.packages("reticulate")
```

#### GoPro setup

#### Image Tests
```{r imports, echo=FALSE, results='hide', message=FALSE}
library(magick)
library(tesseract)
library(knitr)
library(dplyr)
library(pander)
library(purrr)
library(tidyverse)
library(svglite)
library(yaml)
library(df2yaml)
```

```{r options, echo=FALSE, results='hide', message=FALSE}
cache_images <- TRUE
cache_histograms <- TRUE && cache_images

# open picture in GIMP, select area, use position and size values
# (take screenshot of this)
sample_geometry <- "662x746+1564+1822"
number_geometry <- "243x1674+3372+1413"

# adjust light cutoff for rendering numbers as black and white
number_threshold <- "85%"

ocr_cache <- yaml.load_file("ocr.yaml")
```

```{r functions, echo=FALSE, results='hide', message=FALSE}
get_sample_pic <- function(path) {
  image <- image_read(path)
  image <- image_crop(image, sample_geometry)
  return(image)
}

get_number_pic <- function(path) {
  number <- image_read(path)
  number <- image_crop(number, number_geometry)
  number <- image_rotate(number, 90)
  number <- image_reducenoise(number)
  number <- image_modulate(number, saturation = 0)
  number <- image_threshold(number,type="white", threshold=number_threshold) 
  number <- image_threshold(number,type="black", threshold=number_threshold) 
  number <- image_negate(number)
  # target 32px for letter height
  number <- image_scale(number, "250")
  return(number)
}

get_number <- function(image) {
  # https://cran.r-project.org/web/packages/tesseract/vignettes/intro.html
  # 9 is an upside down 6
  dice <- tesseract(options = list(tessedit_char_whitelist = "1234569"))
  text = as.integer(tesseract::ocr(image, engine = dice))
  return(text)
}

tmp_path <- function(prefix, path, extension) {
  path <- basename(path)
  path <- gsub("[^/.]*$", extension, path)
  path <- paste(prefix, path, sep="_")
  return(paste("tmp", path, sep="/"))
}

process_file <- function(file) {
  sample_path = tmp_path("sample", file, "png")
  if (file.exists(sample_path) && cache_images) {
    sample_pic <- image_read(sample_path)
  } else {
    sample_pic = get_sample_pic(file)
    image_write(sample_pic, path=sample_path, format="png" )
  }
  
  number_path = tmp_path("number", file, "png")
  if (file.exists(number_path) && cache_images) {
    number_pic <- image_read(number_path)
  } else {
    number_pic = get_number_pic(file)
    image_write(number_pic, path=number_path, format="png" )
  }
  
  sample_data <- image_data(sample_pic)
  sample_hex <- as.vector(sample_data)
  sample_numeric <- as.numeric(sample_hex)
  pixels  <- data.frame( 
      lightness = sample_numeric
  )
  average <- mean(sample_numeric)
  deviation <- sd(sample_numeric)
  
  filename <- basename(file)
  number <- ocr_cache[[filename]]
  if (!is.integer(number)) {
    number = get_number(number_pic)
  }
  # ocr_comparison = image_annotate(number_pic, number, size="32", color="red")
  
  characters <- strsplit(toString(number), "")[[1]]
  dice <- 36 # rough size of dice in pixels
  canvas <- image_blank(1, 1)  # Initialize a blank canvas
  
  for (i in seq_along(characters)) {
    char <- characters[i]
    die <- image_blank(dice, dice, color="gray90")
    die <- image_annotate(die, char, size=30, gravity="center", font="Ubuntu" )
    canvas <- image_append(c(canvas,die))
  }
  
  ocr_comparison = image_append(c(number_pic, canvas), stack=TRUE)


  ocr_path = tmp_path("ocr", file, "png")
  image_write(ocr_comparison, path=ocr_path, format="png" )
  
  hist_path = tmp_path("hist", file, "svg")
  if (file.exists(hist_path) && cache_histograms) {
  } else {
    ggplot(pixels, aes(x=lightness)) + 
      expand_limits(x=0) +
      expand_limits(x=255) +
      geom_histogram(binwidth=1, color="black") + 
      scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
      scale_x_continuous(expand = expansion(mult = c(0, 0))) +
      theme_minimal() +
      theme(
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "gray90", color = "gray90")
        # panel.border = element_rect(color = "black", fill = NA, size = 0.1)
      )
    ggsave(hist_path, width=4, height=2, units="cm")
  }
      
  df <- data.frame(
    Sample = sample_path %>% pander::pandoc.image.return(),
    sample_path = sample_path,
    OCR = number,
    Filename = basename(file),
    Histogram = hist_path %>% pander::pandoc.image.return(),
    hist_path = hist_path,
    Number = number_path %>% pander::pandoc.image.return(),
    number_path = number_path,
    Average = average,
    Standard_Deviation = deviation,
    Max = max(sample_numeric),
    Min = min(sample_numeric),
    ocr_comparison = ocr_path %>% pander::pandoc.image.return()
  )
  
  return(df)
}
``` 

```{r build_data_frame, echo=FALSE}
files <- list.files("pictures/calibration", full.names = TRUE)
samples <- map_dfr(files, process_file)
```

```{r write_ocr_cache}
ocr_cache <- samples %>% 
  select(Filename, OCR) %>%
  arrange(OCR)
df2yaml(ocr_cache, key_col="Filename", val_col="OCR", out_yaml="ocr.yaml")
```

#### Sample Numbering

Samples are numbered using a 7 digit code using numbers 1-6 and 9.  (Six sides of a die plus 9 as an upside down 6.)

Each digit represents a specific piece of data:

1. Batch Number
    * 1-6 Experiment(s)
    * 9 Calibration Tests (ignore)
1. Grid X
1. Grid Y
1. Oil
    * 1 Light Butter
    * 2 Heavy Butter
    * 3 Light Mayo
    * 4 Heavy Mayo
    * 9 None
1. State
    * 9 Uncooked
    * 1 Grilled
1. Unassigned
    * 9 No meaning
1. Unassigned
    * 9 No meaning

#### OCR Calibration

All data is processed using numbers derived from Optical Character Recognition (OCR).  Use this section to ensure the all numbers have been identified correctly.  The top 
row is the picture of the dice (heavily filtered for better processing) and the shaded gray text is the detected number.  If there are any mistakes edit `ocr.yaml` to make corrections and re-knit this document.
```{r ocr_calibration}
samples %>% 
  arrange(OCR) %>%
  select(Filename, ocr_comparison) %>%
  pander()
```



### E
Describe the dependent variable(s); include the following information:
* a description of how the variable(s)will be quantified, including units of measure
* a description of how the variable(s) will be recorded

###F
Describe at least one external, confounding variable and how it will be controlled. Be sure to justify how your method of controlling that variable will mitigate any confounding effect on observed results.
 
### G
Describe your materials and measurement tools in enough detail that a reader would be able to replicate the experiment.

### H
Describe your experimental procedure in enough detail that a reader would be able to replicate the experiment.
 
## Section IV: Result

### I
Summarize the quantitative data gathered from each experimental manipulation. Be sure to highlight the key findings and trends.

```{r data_table}
samples %>% 
  select(
    Sample,
    Histogram, 
    Min,
    Max,
    Average, 
    Standard_Deviation
  ) %>%
  arrange(Average) %>%
  pander(split.table=Inf)
```


### J
Create a visual representation (i.e., data table, graph, chart) for the data you gathered from each experimental manipulation. Be sure that you choose a method of visual representation that effectively communicates the main findings of your experiment (e.g., exact measurements, trends over time, differences across categories, proportions). Make sure your visual representation clearly represents data for each quantified variable, and be sure to label and align your data accurately. Remember also to choose a scale that fits the range of the data and represent your data points precisely and accurately.
 

## Section V: Conclusions
 

### K
Discuss whether your hypothesis(es) was confirmed, refuted, or partially confirmed. Be sure to describe the observed results supporting your conclusion.

### L
Describe at least one uncontrolled, confounding variable that could have influenced your observed results and any ways the experiment could be improved.
 
### M
Discuss how your experimental results relate to the references presented in the literature review.

## Section VI: Sources
### N
Acknowledge sources, using in-text citations and references, for content that is quoted, paraphrased, or summarized.
